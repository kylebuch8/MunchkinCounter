<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/more-routing/more-route.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html">

<dom-module id="mc-setup">
    <template>
        <more-route context name="setup" params="{{params}}"></more-route>

        <h1>Setup</h1>
        <input is="iron-input" bind-value="{{playerName}}" placeholder="Player Name"> <button on-tap="addPlayer">Add Player</button>

        <template is="dom-repeat" items="{{players}}">
            <div>
                <span>{{item.name}}</span> <button on-tap="removePlayer">Remove</button>
            </div>

            <div>
                <paper-radio-group selected="{{item.color}}" on-paper-radio-group-changed="colorSelected">
                    <paper-radio-button name="#cc0000">Red</paper-radio-button>
                    <paper-radio-button name="green">Green</paper-radio-button>
                    <paper-radio-button name="purple">Purple</paper-radio-button>
                    <paper-radio-button name="orange">Orange</paper-radio-button>
                    <paper-radio-button name="#0854C7">Blue</paper-radio-button>
                    <paper-radio-button name="#ffcc00">Yellow</paper-radio-button>
                </paper-radio-group>
            </div>

            <div>
                <paper-radio-group selected="{{item.gender}}" on-paper-radio-group-changed="genderSelected">
                    <paper-radio-button name="male">Male</paper-radio-button>
                    <paper-radio-button name="female">Female</paper-radio-button>
                </paper-radio-group>
            </div>
        </template>

        <div>
            Winning Level: <input type="number" is="iron-input" bind-value="{{game.winningLevel}}">
        </div>

        <div>
            <button on-tap="playGame">Play</button>
        </div>
    </template>

    <script>

        var gameRef,
            playersRef;

        Polymer({
            is: 'mc-setup',

            properties: {
                params: Object,
                game: Object,
                players: Object,
                playerName: String
            },

            observers: [
                'gameIdChanged(params.gameId)',
                'winningLevelChanged(game.winningLevel)'
            ],

            gameIdChanged: function (gameId) {
                if (!gameId) {
                    return;
                }

                var self = this;

                gameRef = new Firebase('https://munchkincounter.firebaseio.com/games/' + gameId);
                gameRef.on('value', function (snapshot) {
                    self.game = snapshot.val();
                });

                playersRef = new Firebase('https://munchkincounter.firebaseio.com/games/' + gameId + '/players');
                playersRef.on('value', function (snapshot) {
                    self.players = Object.keys(snapshot.val()).map(function (key) {
                        var data = snapshot.val()[key];
                        data.__firebaseKey__ = key;
                        return data;
                    });
                });
            },

            winningLevelChanged: function (level) {
                gameRef.update({
                    winningLevel: level
                });
            },

            addPlayer: function () {
                playersRef.push({
                    name: this.playerName,
                    level: 1
                });

                this.playerName = '';
            },

            removePlayer: function (event) {
                var playerRef = new Firebase('https://munchkincounter.firebaseio.com/games/' + this.params.gameId + '/players/' + event.model.item.__firebaseKey__);
                playerRef.remove();
            },

            colorSelected: function (event) {
                if (!event.target.selected) {
                    return;
                }

                var playerId = event.model.item.__firebaseKey__,
                    playerRef = new Firebase('https://munchkincounter.firebaseio.com/games/' + this.params.gameId + '/players/' + playerId);

                playerRef.update({
                    color: event.target.selected
                });
            },

            genderSelected: function (event) {
                if (!event.target.selected) {
                    return;
                }

                var playerId = event.model.item.__firebaseKey__,
                    playerRef = new Firebase('https://munchkincounter.firebaseio.com/games/' + this.params.gameId + '/players/' + playerId);

                playerRef.update({
                    gender: event.target.selected
                });
            },

            playGame: function () {
                MoreRouting.navigateTo('game', {
                    gameId: this.params.gameId
                });
            }
        });

    </script>
</dom-module>
